
ideahub.controller("projCtrl", ["$scope", "$state", "userData", "appData", "working", '$http', '$timeout',
	function($scope, $state, userData, appData, working, $http, $timeout, PubNub){


	$scope.goProject = function(project){

		working.curProj = project;
		$state.transitionTo("documents");
	}

	$scope.userData = userData;
	$scope.appData = document.tmp10 = appData;
  $scope.notification = 'notification';
  
  /*
  * create a unique id for each session
  * until user enter an email, this id is used for communication
  */  
  // if(!$scope.email) {
  var val = Math.floor(Math.random() * 100);
  console.log("val = ", val);
  // } else {
  //   var val = $scope.email;
  // }
  
  var registerId = function() {
    $http.put(config.server + '/id', {data: val}).
      success(function(data, status) {
        console.log("register id success", data);
      }).
      error(function(data, status) {
        console.log("fail", data);
      });
  }

  $timeout(registerId, 100);
  
  
  
  /*
  * auto subscribe to channel
  * channel generated by id / email
  */
  var pubnub = PUBNUB.init({
    publish_key   : "pub-c-8f3f9072-f2ea-4797-978c-0ae8279e4d9e",
    subscribe_key : "sub-c-13492cec-9330-11e3-b381-02ee2ddab7fe"
  });
      
  pubnub.subscribe({
    channel : val,
    message : function(m){ 
      console.log("receive data", m);
      $scope.$apply(function() {
        $scope.notification = "a new update has been made to document <a href='#'>abcdef</a>";
      });

    },
  });
}]);
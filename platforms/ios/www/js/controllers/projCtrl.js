
ideahub.controller("projCtrl", ["$scope", "$state", "userData", "appData", "working", '$http', '$timeout', "$ionicPopup",
	function($scope, $state, userData, appData, working, $http, $timeout, $ionicPopup, PubNub){
  
	$scope.goProject = function(project){
		working.curProj = project;
		$state.transitionTo("documents");
	}

	$scope.userData = userData;
	$scope.appData = document.tmp10 = appData;
  $scope.notification = '';
  
  /*
  * create a unique id for each session
  * until user enter an email, this id is used for communication
  */  

  var registerId = function() {
    $http.put(config.server + '/id', {data: $scope.userData.email}).
      success(function(data, status) {
        console.log("register id success", data);
      }).
      error(function(data, status) {
        console.log("fail", data);
      });
  }

  $timeout(registerId, 100);

  $scope.registerEmail = function() {
    $http.put(config.server + '/email', {email: $scope.userData.email}).
      success(function(data, status) {
        console.log("register email success", data);
        goSub(data.registerEmail);
        alertPop();
      }).
      error(function(data, status) {
        console.log("fail", data);
      });
  }

  
  /*
  * auto subscribe to channel
  * channel generated by id / email
  */
  var pubnub = PUBNUB.init({
    publish_key   : "pub-c-8f3f9072-f2ea-4797-978c-0ae8279e4d9e",
    subscribe_key : "sub-c-13492cec-9330-11e3-b381-02ee2ddab7fe"
  });
  
  var goSub = function(channel) {
    pubnub.subscribe({
    channel : channel,
    message : function(m){ 
      console.log("receive data", m, channel);
      //$scope.$apply(function() {
        //$scope.notification = "http://localhost:7004/#/pages";
      confirmPop(m);
      
      //});
    },
  })};

  goSub($scope.userData.email);

  var gogo = (function(m) {
    working.curProj = m.projects[0];
      working.curDoc = working.curProj.docs[0];
      $state.transitionTo("pages");
  });
  var confirmPop = function(m) {
    $scope.data = {}

    // An elaborate, custom popup
    var myPopup = $ionicPopup.show({
      template: '<input type="text" ng-model="data.email">',
      title: 'Type ok to go to updated pate',
      subTitle: 'be sure to be okay',
      scope: $scope,
      buttons: [
        { text: 'Cancel' },
        {
          text: '<b>Save</b>',
          type: 'button-positive',
          onTap: function(e) {
            
            if (!$scope.data.email) {
              //don't allow the user to close unless he enters wifi password
              e.preventDefault();
            } else {
              gogo(m);
            }
          }
        },
      ]
    });
    myPopup.then(function(res) {
      console.log('go go go!', res);
    });
    
  }
  
  var alertPop = function() {
    $scope.data = {}

    // An elaborate, custom popup
    var myPopup = $ionicPopup.show({
      
      title: 'Register ID successful',
      subTitle: 'it would be awesome',
      scope: $scope,
      buttons: [
        
        {
          text: '<b>OK</b>',
          type: 'button-positive',
          onTap: function(e) {
            console.log('okey');
            
          }
        },
      ]
    });
    myPopup.then(function(res) {
      console.log('go go go!', res);
    });
    
  }
}]);

ideahub.controller("projCtrl", ["$scope", "$state", "userData", "appData", "working", '$http', '$timeout',
	function($scope, $state, userData, appData, working, $http, $timeout, PubNub){

  
	$scope.goProject = function(project){

		working.curProj = project;
		$state.transitionTo("documents");
	}

	$scope.userData = userData;
	$scope.appData = appData;
  $scope.notification = '';
  
  /*
  * create a unique id for each session
  * until user enter an email, this id is used for communication
  */  
  if(!$scope.userData.email) {
    var val = Math.floor(Math.random() * 100);
    console.log("val = ", val);
  } else {
    var val = $scope.userData.email;
  }
  
  var registerId = function() {
    $http.put(config.server + '/id', {data: val}).
      success(function(data, status) {
        console.log("register id success", data);
      }).
      error(function(data, status) {
        console.log("fail", data);
      });
  }

  $timeout(registerId, 100);

  $scope.registerEmail = function(val) {
    $http.put(config.server + '/email', {email: val}).
      success(function(data, status) {
        console.log("register email success", data);
        goSub(data.registerEmail);
      }).
      error(function(data, status) {
        console.log("fail", data);
      });
  }

  
  /*
  * auto subscribe to channel
  * channel generated by id / email
  */
  var pubnub = PUBNUB.init({
    publish_key   : "pub-c-8f3f9072-f2ea-4797-978c-0ae8279e4d9e",
    subscribe_key : "sub-c-13492cec-9330-11e3-b381-02ee2ddab7fe"
  });
  
  var goSub = function(channel) {
    pubnub.subscribe({
    channel : channel,
    message : function(m){ 
      console.log("receive data", m, channel);
      $scope.$apply(function() {
        $scope.notification = "http://localhost:7004/#/pages";
      });

    },
  })};

  goSub(val);

  
  
  
}]);
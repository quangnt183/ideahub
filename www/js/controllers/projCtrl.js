
ideahub.controller("projCtrl", ["$scope", "$state", "userData", "appData", "working", '$http',
	function($scope, $state, userData, appData, working, $http, PubNub){


	$scope.goProject = function(project){

		working.curProj = project;
		$state.transitionTo("documents");
	}

	$scope.userData = userData;
	$scope.appData = appData;
  $scope.notification = 'notification';
  
  /*
  * create a unique id for each session
  * until user enter an email, this id is used for communication
  */  
  var val = Math.floor(Math.random() * 100);
  console.log("val = ", val);
  
  var registerId = function() {
    $http.put(config.server + '/id', {data: val}).
      success(function(data, status) {
        console.log("register id success", data);
      }).
      error(function(data, status) {
        console.log("fail", data);
      });
  }

  setTimeout(registerId, 100);


  /*
  * fire whenever user press Save to online
  * need full data of current document to be assigned to data
  */
  $scope.saveDocument = function(val) {
    data = {
      x: 'x',
      y: 'y'
    }
    $http.put(config.server + '/save', {data: data, ids: val}).
      success(function(data, status) {
        console.log("success", data);
        $scope.notification = 'saved document successful';
      }).
      error(function(data, status) {
        console.log("fail", data);
      });
  }
  
  /*
  * auto subscribe to channel
  * channel generated by id / email
  */
  var pubnub = PUBNUB.init({
    publish_key   : "pub-c-8f3f9072-f2ea-4797-978c-0ae8279e4d9e",
    subscribe_key : "sub-c-13492cec-9330-11e3-b381-02ee2ddab7fe"
  });
      
  pubnub.subscribe({
    channel : val,
    message : function(m){ 
      console.log("receive data", m);
      $scope.$apply(function() {
        $scope.notification = "a new update has been made to document <link>";
      });

    },
  });
}]);